---
title: "PWD profiles by CTCF"
author: "ks"
date: "2024-09-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=FALSE}
library(GenomicRanges)
library(data.table)
library(ggplot2)
```


## Get CTCF intervals

```{r read-ctcf-motifs}
load("data/ctcf_motifs.rda")
table(values(ctcf_motifs)$cancer_type)
values(ctcf_motifs)$ctcf_idx <- 1:length(ctcf_motifs)
```

## Get Normal and Tumor I PWDs

```{r load-data}
filtered_data <- readRDS("~kims/github/sandbox/bsseq/data/filtered_data.rds")
values(filtered_data)$pos <- start(filtered_data)

mp_n <- filtered_data[which(is.element(values(filtered_data)$sample,c("JN","IN")))]
```

when do I merge?

```{r JN-IN}
fO <- findOverlaps(ctcf_motifs, filtered_data[values(filtered_data)$sample=="JN"])
fO
```

subset the DNAm data to the interval and then find the matching position from the paired sample. The first pair is matching JN and IN.
```{r}
jn <- filtered_data[subjectHits(fO)]
f1 <- findOverlaps(jn,
              filtered_data[values(filtered_data)$sample=="IN"])
f1
sample.in <- filtered_data[values(filtered_data)$sample=="IN"][subjectHits(f1)]
sample.in
```


```{r}
ctcf_jn <- ctcf_motifs[queryHits(fO)]
values(ctcf_jn) <- DataFrame(values(ctcf_jn),
                             values(filtered_data[subjectHits(fO)]))

summary(values(ctcf_jn)$depth)
```


Summarize number of CpGs and the beta value by CTCF motif interval.
```{r summarize-jn-by-ctcfmotif}
Dt <- as.data.table(values(ctcf_jn))

Dt <- Dt[order(ctcf_idx)]
sDt <- Dt[depth > 4 ,.( nCpG = .N,
           avg_beta = mean(beta),
           summ     = sum(m),
           sumdepth = sum(depth)), by = ctcf_idx]
sDt$poolbeta <- sDt$summ/sDt$sumdepth
nrow(sDt)
table(sDt$nCpG)
```
Now overlap JN & IN, before merging the data with the ctcf motif intervals.
```{r}
jn <- filtered_data[values(filtered_data)$sample=="JN"]
jn

```






## Stratify by interval averaged DNAm level

How many TSSs are in or not in CpG islands, grouped by average beta value of interval?
```{r Dt-counts}
mDt <- mDt[order(TSSinCGI,cat_region_avg_beta)]
mDt[, .(unique_tss_count = uniqueN(tssgene_id)), 
              by = c("TSSinCGI","cat_region_avg_beta")]
```

```{r avgbeta}
mDt <- mDt[order(TSSinCGI,cat_region_avg_beta,pos)]
avgpwd <- mDt[, .(avg_pwd = mean(pwd)), 
                  by = c("TSSinCGI","cat_region_avg_beta","pos")]
avgpwd <- avgpwd[order(TSSinCGI,cat_region_avg_beta,pos)]
```

```{r}
ggplot(avgpwd) +
        #geom_point(aes(x=pos,y=avg_pwd,color=cat_region_avg_beta), alpha=0.3) +
        geom_smooth(aes(x=pos,y=avg_pwd,color=cat_region_avg_beta)) +
        facet_grid( ~ TSSinCGI)
```




## Stratify by number of CpGs in interval




```{r sI}
sessionInfo()
```

