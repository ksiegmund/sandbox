---
title: "Summarize Regions"
author: "ks"
date: "2024-09-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=FALSE}
library(GenomicRanges)
library(data.table)
library(ggplot2)
```

# Summarize TSS intervals

```{r load-data}
load("data/beta.by.region.rda")

Dt <- as.data.table(values(beta.by.region))
Dt$pos <- start(beta.by.region) - 
                values(beta.by.region)$tss500 + 1 - 501

Dt$group <- ifelse(Dt$pos<0, 1,
                   ifelse(Dt$pos==0, 2, 3))
head(Dt)
```

Let's count the number of CpGs by region, avg_beta, sd_beta, and study their relationship. 

```{r count_CpGs, cache=TRUE}
sum.tssregion <- Dt[, .(   region_n_CpG = .N,
                        region_avg_beta = mean(beta),
                         region_sd_beta = sd(beta)), 
                    by = c("tssgene_id")]
sum.tssregion
```

How many TSS regions? `r nrow(sum.tssregion)`  
How many regions have singleton CpGs? `r sum(sum.tssregion$region_n_CpG==1)`  
How many regions (`#` CpG > 1) have average beta = 0? `r nrow(sum.tssregion[region_n_CpG>1 & region_avg_beta == 0])`  
How many regions (`#` CpG > 1) have average beta = 1? `r nrow(sum.tssregion[region_n_CpG>1 & region_avg_beta == 1])`   

Now let's remove regions with singleton CpG and categorize region_avg_beta into 3 levels:  < 0.05,  0.05-0.95, >0.95.

```{r}
filt_sum.tssregion <- sum.tssregion[ region_n_CpG > 1 ]
filt_sum.tssregion <- 
        filt_sum.tssregion[,
              .(cat_region_avg_beta = 
                      ifelse(region_avg_beta < 0.05,1,
                      ifelse(region_avg_beta > 0.95,3,2)))]
table(filt_sum.tssregion$cat_region_avg_beta)
```

```{r save_region_summaries}
save(filt_sum.tssregion,file="data/filt_sum.tssregion.rda")
```

